package cn.itcast.spark.day2own

import org.apache.spark.{SparkConf, SparkContext}

/**
  * \* Created with IntelliJ IDEA.
  * \* Author: acer zjl
  * \* Date: 2018/7/26 9:52
  * \* Description: 
  * \*/
object AdvUserLocation2 {

  def main(args: Array[String]): Unit = {
    val conf = new SparkConf().setAppName("AdvUserLocation2").setMaster("local[2]")
    val sc = new SparkContext(conf)

    val rdd0 = sc.textFile("E://BigData//Scala//practice//bs_log").map(line => {
      val fields = line.split(",")
      val eventType = fields(3)
      val time = fields(1)
      val timeLong = if (eventType == "1") -time.toLong else time.toLong
      ((fields(0), fields(2)), timeLong)
    })
    /*(rdd0,ArrayBuffer(((18688888888,16030401EAFB68F1E3CDF819735E1C66),-20160327082400), ((18611132889,16030401EAFB68F1E3CDF819735E1C66),-20160327082500), ((18688888888,16030401EAFB68F1E3CDF819735E1C66),20160327170000), ((18611132889,16030401EAFB68F1E3CDF819735E1C66),20160327180000), ((18611132889,9F36407EAD0629FC166F14DDE7970F68),-20160327075000), ((18688888888,9F36407EAD0629FC166F14DDE7970F68),-20160327075100), ((18611132889,9F36407EAD0629FC166F14DDE7970F68),20160327081000), ((18688888888,9F36407EAD0629FC166F14DDE7970F68),20160327081300), ((18688888888,9F36407EAD0629FC166F14DDE7970F68),-20160327175000), ((18611132889,9F36407EAD0629FC166F14DDE7970F68),-20160327182000), ((18688888888,9F36407EAD0629FC166F14DDE7970F68),20160327220000), ((18611132889,9F36407EAD0629FC166F14DDE7970F68),20160327230000), ((18611132889,CC0710CC94ECC657A8561DE549D940E0),-20160327081100), ((18688888888,CC0710CC94ECC657A8561DE549D940E0),-20160327081200), ((18688888888,CC0710CC94ECC657A8561DE549D940E0),20160327081900), ((18611132889,CC0710CC94ECC657A8561DE549D940E0),20160327082000), ((18688888888,CC0710CC94ECC657A8561DE549D940E0),-20160327171000), ((18688888888,CC0710CC94ECC657A8561DE549D940E0),20160327171600), ((18611132889,CC0710CC94ECC657A8561DE549D940E0),-20160327180500), ((18611132889,CC0710CC94ECC657A8561DE549D940E0),20160327181500)))
*/
    println("rdd0", rdd0.collect().toBuffer)

    val rdd1 = rdd0.reduceByKey(_+_).map(t => {
      val mobile = t._1._1
      val lac = t._1._2
      val time = t._2
      (lac,(mobile,time))
    })
    /*(rdd1,ArrayBuffer((CC0710CC94ECC657A8561DE549D940E0,(18688888888,1300)), (9F36407EAD0629FC166F14DDE7970F68,(18611132889,54000)), (9F36407EAD0629FC166F14DDE7970F68,(18688888888,51200)), (16030401EAFB68F1E3CDF819735E1C66,(18688888888,87600)), (CC0710CC94ECC657A8561DE549D940E0,(18611132889,1900)), (16030401EAFB68F1E3CDF819735E1C66,(18611132889,97500))))
*/
    println("rdd1",rdd1.collect().toBuffer)

    val rdd2 = sc.textFile("E://BigData//Scala//practice//loc_info.txt").map(line => {
      val fields = line.split(",")
      /*基站id     (经度，纬度)*/
      (fields(0),(fields(1),fields(2)))
    })
    /*(rdd2,ArrayBuffer((9F36407EAD0629FC166F14DDE7970F68,(116.304864,40.050645)), (CC0710CC94ECC657A8561DE549D940E0,(116.303955,40.041935)), (16030401EAFB68F1E3CDF819735E1C66,(116.296302,40.032296))))
*/
    println("rdd2",rdd2.collect().toBuffer)

    val rdd3 = rdd1.join(rdd2).map(t => {
      val lac = t._1
      val mobile = t._2._1._1
      val time = t._2._1._2
      val x = t._2._2._1
      val y = t._2._2._2
      (mobile,lac,time,x,y)
    })
    /*ArrayBuffer((18688888888,CC0710CC94ECC657A8561DE549D940E0,1300,116.303955,40.041935), (18611132889,CC0710CC94ECC657A8561DE549D940E0,1900,116.303955,40.041935), (18688888888,16030401EAFB68F1E3CDF819735E1C66,87600,116.296302,40.032296), (18611132889,16030401EAFB68F1E3CDF819735E1C66,97500,116.296302,40.032296), (18611132889,9F36407EAD0629FC166F14DDE7970F68,54000,116.304864,40.050645), (18688888888,9F36407EAD0629FC166F14DDE7970F68,51200,116.304864,40.050645))*/
    println("rdd3",rdd3.collect().toBuffer)


    val rdd4 = rdd3.groupBy(_._1).mapValues(it => {

       it.toList.sortBy(_._3).reverse
    })
    println(rdd4.collect().toBuffer)
    rdd4.saveAsTextFile("E://BigData//Scala//practice//out")

    sc.stop()
  }

}
